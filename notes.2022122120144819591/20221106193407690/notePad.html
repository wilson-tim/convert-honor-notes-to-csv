<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>notePad</title>
</head>
<style>
#notePad{
    width: 95%;
    margin: 0 auto;
    border: 1px solid #eee;
    padding: 20px;
    box-shadow: inset -10px 0 50px #eee;
    font-size: 16px;
}
div{
    width: 100%;
}
.textLine{ 
    line-height: 25px;
    color: #333;
    display: inline-block;
    width: 100%;
    word-wrap: break-word;
    white-space: pre-wrap;
    word-break: normal;
}
.bulletLine{
    line-height: 25px;
    color: #333;
    display: inline-block;
    position: relative;
}
.bulletText{
    padding-left: 30px;
    word-wrap: break-word;
    white-space: pre-wrap;
    word-break: normal;
    width: 96%;
}
.bullet{
    width: 24px;
    height: 24px;
    cursor: default;
    margin: -2px;
    position: absolute;
    top: 3px;
}
.bulletImg {
    background-image: url(data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0idXRmLTgiPz4KPCEtLSBHZW5lcmF0b3I6IEFkb2JlIElsbHVzdHJhdG9yIDIxLjAuMCwgU1ZHIEV4cG9ydCBQbHVnLUluIC4gU1ZHIFZlcnNpb246IDYuMDAgQnVpbGQgMCkgIC0tPgo8c3ZnIHZlcnNpb249IjEuMSIgaWQ9IuWbvuWxgl8xIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiB4PSIwcHgiIHk9IjBweCIKCSB2aWV3Qm94PSIwIDAgMzIgMzIiIHN0eWxlPSJlbmFibGUtYmFja2dyb3VuZDpuZXcgMCAwIDMyIDMyOyIgeG1sOnNwYWNlPSJwcmVzZXJ2ZSI+CjxzdHlsZSB0eXBlPSJ0ZXh0L2NzcyI+Cgkuc3Qwe29wYWNpdHk6MDt9Cgkuc3Qxe2ZpbGwtcnVsZTpldmVub2RkO2NsaXAtcnVsZTpldmVub2RkO30KPC9zdHlsZT4KPGc+Cgk8cGF0aCBkPSJNMTYsM0M4LjgsMywzLDguOCwzLDE2czUuOCwxMywxMywxM2M3LjIsMCwxMy01LjgsMTMtMTNTMjMuMiwzLDE2LDN6IE0xNiwyN0M5LjksMjcsNSwyMi4xLDUsMTZTOS45LDUsMTYsNQoJCWM2LjEsMCwxMSw0LjksMTEsMTFTMjIuMSwyNywxNiwyN3oiIGZpbGw9IiM5OTk5OTkiLz4KPC9nPgo8L3N2Zz4K);
}
.finished .bulletImg{
    background-image: url(data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0idXRmLTgiPz4KPCEtLSBHZW5lcmF0b3I6IEFkb2JlIElsbHVzdHJhdG9yIDIxLjAuMCwgU1ZHIEV4cG9ydCBQbHVnLUluIC4gU1ZHIFZlcnNpb246IDYuMDAgQnVpbGQgMCkgIC0tPgo8c3ZnIHZlcnNpb249IjEuMSIgaWQ9IuWbvuWxgl8xIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiB4PSIwcHgiIHk9IjBweCIKCSB2aWV3Qm94PSIwIDAgMzIgMzIiIHN0eWxlPSJlbmFibGUtYmFja2dyb3VuZDpuZXcgMCAwIDMyIDMyOyIgeG1sOnNwYWNlPSJwcmVzZXJ2ZSI+CjxzdHlsZSB0eXBlPSJ0ZXh0L2NzcyI+Cgkuc3Qwe29wYWNpdHk6MDt9Cgkuc3Qxe2ZpbGwtcnVsZTpldmVub2RkO2NsaXAtcnVsZTpldmVub2RkO30KPC9zdHlsZT4KPGc+Cgk8cGF0aCBkPSJNMTYsM0M4LjgsMywzLDguOCwzLDE2czUuOCwxMywxMywxM2M3LjIsMCwxMy01LjgsMTMtMTNTMjMuMiwzLDE2LDN6IE0xNiwyN0M5LjksMjcsNSwyMi4xLDUsMTZTOS45LDUsMTYsNQoJCWM2LjEsMCwxMSw0LjksMTEsMTFTMjIuMSwyNywxNiwyN3oiIGZpbGw9IiM5OTk5OTkiLz4KCTxwYXRoIGQ9Ik0yMi43LDEyLjNjLTAuNC0wLjQtMS0wLjQtMS40LDBMMTUsMTguNmwtMy4zLTMuM2MtMC40LTAuNC0xLTAuNC0xLjQsMGwtMC4xLDAuMWMtMC40LDAuNC0wLjQsMSwwLDEuNGw0LDQKCQljMC40LDAuNCwxLDAuNCwxLjQsMGwwLDBjMCwwLDAsMCwwLDBsNy03QzIzLjEsMTMuNCwyMy4xLDEyLjcsMjIuNywxMi4zTDIyLjcsMTIuM3oiIGZpbGw9IiM5OTk5OTkiLz4KPC9nPgo8L3N2Zz4K);
}
.finished {
    text-decoration: line-through!important;
}
.imgLine {
    width: 100%;
}
.imgContext{
    width: 380px;
    margin: 4px 0;
}
.timeLine {
    color: #999;
    font-size: 14px;
    font-weight: 400;
    padding: 25px 0;
    line-height: 70px;
    height: 70px;
    width: 100%;
}
.audioLine{
    display: block;
    line-height: 0;
    padding: 5px 0;
    height: auto;
}
</style>
<body>
    <div id="notePad">
	    <span class="timeLine"></span>
        <span class="audioLine">
            <audio controls="controls" style="display:none">
            </audio>
        </span>
    </div>
</body>
</html>
<script src="json.js"></script>
<script>
    var convertFromContent = function(str,fileList) {
        var paragraphs = str.split('<>><><<<');
        var pgs = [];
        paragraphs.forEach(function(item) {
            var periodPair = item.split('|');
            var periodType = periodPair[0];
            periodPair.shift();
            var periodContent = periodPair.join("|");
            var realItem = {};
            realItem.type = periodType;
            if (periodType == "Text") {
                realItem.content = periodContent;
            } else if (periodType == "Attachment") {
                var arrs = periodContent.split('/');
                realItem.fileName = arrs[arrs.length - 1];
                if(fileList != null && fileList.length >0) {
                    fileList.forEach(function (data) {
                        if (data.name == realItem.fileName) {
                            realItem.src = data.hash;
                        }
                    })
                }
            } else if (periodType == "Bullet") {
                realItem.content = periodContent.substr(1, periodContent.length - 1);
                var _periodContent = periodContent.substr(0, 1);
                realItem.finished = parseInt(_periodContent) != 0 ? true : false;
            }
            pgs.push(realItem);
        })
        return pgs;
    }
    var conver2Editor = function(contents) { //新逻辑 读取
        var wholeCode = "";
        var addOn = [];
        var textLine,bulletLine,imgLine,bulletImg,bulletText,imgContext;
        var notePad = document.getElementById("notePad");

        contents.forEach(function(item, index) {
            var end = "";
            if (index != contents.length - 1) {
                end = "\n";
            }
            if (item.type == "Text") {
                textLine = document.createElement("span");
                textLine.className = "textLine";
                textLine.innerText = item.content;

                notePad.appendChild(textLine);
            }
            else if (item.type == "Bullet") {
                bulletLine = document.createElement("div");
                if (!!item.finished) {
                    bulletLine.className = "bulletLine finished";
                }else{
                    bulletLine.className = "bulletLine";
                }

                bulletText = document.createElement("div");
                bulletText.className = "bulletText"
                bulletText.innerText = item.content;

                bulletImg = document.createElement("span");
                bulletImg.className = "bullet bulletImg";
                
                bulletLine.appendChild(bulletImg);
                bulletLine.appendChild(bulletText);
                notePad.appendChild(bulletLine);
            }
            else if (item.type == "Attachment") {
                if (item.fileName.indexOf('graffiti') < 0) {
                    imgLine = document.createElement("div");
                    imgContext = document.createElement("img");
                    imgContext.className = "imgLine";
                    imgContext.className = "imgContext";
                    imgContext.src = "attachment/" + item.fileName;
                    imgLine.appendChild(imgContext);
                    notePad.appendChild(imgLine);
                }
            }
			else
			{
			    if(item.type && !item.content)
				{
				    textLine = document.createElement("span");
                    textLine.className = "textLine";
                    textLine.innerText = item.type;

                    notePad.appendChild(textLine);
				}
				
			    
			}
        });
    }
    //java 时间戳转换
    var transFromJavaTimstamp = function(time) {
        time = parseInt(time);
        var date = new Date(time);
        var hour = date.getHours();
        var timef = "{0}:{1}";
        var minute = date.getMinutes();
        minute < 10 && (minute = "0" + minute);
        hour < 10 && (hour = "0" + hour);
        var MN = timef.format(hour, minute);
        var timef2 = "{0} {1} {2}";
        //早于昨天显示日期
        var date = new Date(time);
        var year = date.getFullYear();
        var month = date.getMonth() + 1;
        var m = new Array("Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Spt","Oct","Nov","Dec");
        var day = date.getDate();
        var mn = date.getMonth();
        month < 10 && (month = "" + month);
        day < 10 && (day = "" + day);
        var DMY = timef2.format(day, m[mn], year);
        return DMY + ", " + MN;
                
    }
    //原生js扩展部分
    String.prototype.format = function(args) {
        var result = this;
        if (arguments.length > 0) {
            if (arguments.length == 1 && typeof(args) == "object") {
                for (var keyAr in args) {
                    if (args[keyAr] != undefined) {
                        var regRule = new RegExp("({" + keyAr + "})", "g");
                        result = result.replace(regRule, args[keyAr]);
                    }
                }
            } else {
                for (var i = 0; i < arguments.length; i++) {
                    if (arguments[i] != undefined) {
                        var regRule = new RegExp("({)" + i + "(})", "g");
                        result = result.replace(regRule, arguments[i]);
                    }
                }
            }
        }
        return result;
    }
	function addAudioLine(fileList){
	     var surfix = ["m4a","amr","mp3","wav"];
		 
		 var audioName="";
		 var tempEnd;
		 if(fileList && fileList.length>0){
		     fileList.forEach(function(item,index){
			     
			     if(item.name && item.name.length>0)
				 {
				   tempEnd = item.name.substring(item.name.lastIndexOf('.')+1);
				 }
				 
				 if(tempEnd)
				 {
				     for(var i=0;i<surfix.length;i++)
					 {
					     if(tempEnd == surfix[i])
						 {
						     audioName = item.name;
						     return;
						 }
					 }
				 }
				
			 }
			 );
		 }
		 
		 if(audioName && audioName.length>0)
		 {
             var audioLineDom = document.getElementsByClassName("audioLine")[0].getElementsByTagName("audio")[0];
             audioLineDom.style = "display:block";
             var sourceDom = document.createElement("source");
             sourceDom.src = "attachment/" + audioName;
             sourceDom.type = "audio/mpeg";
             audioLineDom.appendChild(sourceDom);
		 }
		 
	}
	
    window.onload=function(){
        var jsonData = data.content.content;
        var modified = transFromJavaTimstamp(data.content.modified);
        var fileList = data.fileList;
        var content = convertFromContent(jsonData,fileList);
		//audio
		addAudioLine(fileList);
        document.getElementsByClassName("timeLine")[0].innerText = modified;
        //赋值
        conver2Editor(content);
    }
</script>


